VibiShowdown - Ordem atual do sistema (oficial-only)
=====================================================

Objetivo deste arquivo
----------------------
Documentar a ordem de execucao principal do app hoje:
1) ordem de rede/sincronizacao
2) ordem de processamento de turno no motor de combate


1) Ordem de rede (cliente)
--------------------------
Arquivo principal: vibishowdown/index.ts

Fluxo de inicializacao:
1. Cliente abre websocket via pacote oficial `vibinet` (src/client.ts).
2. Em on_sync:
   - watch(room, consume_network_message)
   - load(room, 0, consume_network_message)
   - post(join)
   - status muda para "synced"
   - app considera sincronizacao de tempo completa.

Fluxo de mensagem recebida (consume_network_message):
1. Deduplica por index (quando index >= 0).
2. Se mensagem for "server-managed" (assign/ready_state/participants/turn_start/state/intent_locked):
   - ativa modo server-managed
   - encaminha direto para handle_post.
3. Se ja estiver em server-managed:
   - encaminha direto para handle_post.
4. Caso contrario:
   - usa fallback cliente-deterministico (relay_consume_post)
   - reconstrui estado local a partir de join/ready/intent/forced_switch/surrender/chat.

Observacao:
- Mesmo com fallback deterministico, o endpoint permanece oficial:
  wss://net.studiovibi.com
- Nao existe backend local de jogo neste repositorio.
- Nao existe protocolo custom local (`src/vibinet/*` foi removido).


2) Ordem de combate (engine)
----------------------------
Arquivo principal: src/engine.ts

Funcao central: resolve_turn(state, intents)

Ordem exata atual:
1. clone_state do estado recebido.
2. build_actions a partir dos intents.
3. Ordena fases por "order":
   - switch (0)
   - guard (1)
   - attack_01 (2)
4. Para cada fase:
   - filtra actions da fase
   - se houver duas actions, resolve iniciativa
   - executa action por action
   - valida fim de partida apos cada action
5. Fase final unica:
   - end_turn (ordem fixa por lista interna, sem iniciativa por atributos):
     Wish -> Leftovers -> Leech Life
   - apos cada bloco dessa lista, o engine valida fim de partida (KO no fim do turno).
6. Encerramento do turno:
   - decrement_cooldowns
   - reset_protect_flags no fim do turno

Importante sobre passivas:
- Passivas de item (ex: Leftovers) acontecem dentro da fase end_turn.
- A logica da passiva fica no modulo de passivas:
  src/game_default/passives.ts
- O engine chama apply_passive_turn_effect(...) para cada player ativo.


3) Onde alterar cada tipo de regra
----------------------------------
Cadastro de dados:
- Pokemons/defaults: src/game_default/pokemon.ts
- Moves/catalogo: src/game_default/moves.ts
- Passivas/catalogo + efeitos: src/game_default/passives.ts
- Check de integridade: src/game_default/integrity.ts

Ordem de execucao:
- Sempre em src/engine.ts (resolve_turn e funcoes auxiliares).
